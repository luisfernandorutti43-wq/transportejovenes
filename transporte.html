<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENATI Intranet - Sistema de Encuestas de Transporte</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* (todo tu CSS anterior sin cambios) */
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:#f5f6fa;color:#2c3e50;font-size:14px;line-height:1.5}
        .header{background:#fff;border-bottom:1px solid #e1e8ed;padding:12px 20px;position:sticky;top:0;z-index:1000}
        .header-content{display:flex;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto}
        .logo-section{display:flex;align-items:center;gap:10px}
        .logo{width:32px;height:32px;background:#3498db;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:14px}
        .header-title{font-size:16px;font-weight:600;color:#2c3e50}
        .header-subtitle{font-size:13px;color:#7f8c8d;margin-top:-2px}
        .participants-info{display:flex;align-items:center;gap:6px;color:#27ae60;font-size:13px;font-weight:500}
        .nav-tabs{background:#fff;border-bottom:1px solid #e1e8ed;padding:0 20px}
        .nav-tabs-content{max-width:1200px;margin:0 auto;display:flex;gap:32px}
        .nav-tab{padding:14px 0;font-size:14px;color:#7f8c8d;text-decoration:none;border-bottom:2px solid transparent;font-weight:500}
        .nav-tab.active{color:#3498db;border-bottom-color:#3498db}
        .container{max-width:1200px;margin:0 auto;padding:24px}
        .page-header{margin-bottom:24px}
        .page-title{font-size:24px;font-weight:600;color:#2c3e50;margin-bottom:6px}
        .page-subtitle{font-size:14px;color:#7f8c8d}
        .metrics-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px}
        .metric-card{background:#fff;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .metric-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .metric-label{font-size:12px;color:#7f8c8d;font-weight:600}
        .metric-icon{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px}
        .metric-icon.blue{background:#3498db}.metric-icon.green{background:#27ae60}.metric-icon.purple{background:#9b59b6}.metric-icon.orange{background:#e67e22}
        .metric-value{font-size:32px;font-weight:700;color:#2c3e50}
        .main-grid{display:grid;grid-template-columns:1fr 1fr 400px;gap:20px;margin-bottom:32px}
        .chart-card{background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);padding:20px}
        .card-title{font-size:16px;font-weight:600;color:#2c3e50;margin-bottom:20px}
        .chart-container{height:300px;position:relative}
        .form-card{background:#fff;border-radius:8px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.1);height:fit-content}
        .form-group{margin-bottom:16px}
        .form-label{display:block;font-size:12px;font-weight:600;color:#2c3e50;margin-bottom:4px;text-transform:uppercase;letter-spacing:.3px}
        .form-input,.form-select{width:100%;padding:8px 12px;border:1px solid #ccd0d5;border-radius:4px;font-size:13px;color:#2c3e50;background:#fff;transition:border-color .15s ease}
        .form-input:focus,.form-select:focus{outline:none;border-color:#3498db}
        .transport-options{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:6px}
        .transport-option{display:flex;align-items:center;padding:8px 12px;border:1px solid #ccd0d5;border-radius:4px;cursor:pointer;transition:border-color .15s ease;background:#fff}
        .transport-option:hover{border-color:#3498db}
        .transport-option.selected{border-color:#3498db;background:#ebf3fd}
        .transport-option input{margin-right:6px}
        .transport-option label{font-size:13px;color:#2c3e50;cursor:pointer}
        .btn-submit{background:#3498db;color:#fff;border:none;padding:10px 16px;border-radius:4px;font-size:13px;font-weight:600;cursor:pointer;transition:background-color .15s ease;width:100%}
        .btn-submit:hover{background:#2980b9}
        .success-message{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:10px 12px;border-radius:4px;margin-top:12px;font-size:13px;display:none}
        .table-card{background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:hidden}
        .table-header{padding:20px;border-bottom:1px solid #e1e8ed}
        .table-title{font-size:16px;font-weight:600;color:#2c3e50}
        .table-container{overflow-x:auto}
        .data-table{width:100%;border-collapse:collapse}
        .data-table th{background:#f8f9fa;padding:12px 20px;text-align:left;font-size:12px;font-weight:600;color:#7f8c8d;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #e1e8ed}
        .data-table td{padding:16px 20px;font-size:14px;color:#2c3e50;border-bottom:1px solid #ecf0f1}
        .data-table tr:hover{background:#f8f9fa}
        .status-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:capitalize}
        .badge-bus{background:#ebf3fd;color:#3498db}.badge-auto{background:#fdf2e9;color:#e67e22}.badge-bicicleta{background:#eafaf1;color:#27ae60}.badge-caminata{background:#fdeaea;color:#e74c3c}
        .source-web{background:#eafaf1;color:#27ae60}.source-chatbot{background:#ebf3fd;color:#3498db}
        @media(max-width:1024px){.main-grid{grid-template-columns:1fr}.metrics-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:768px){.metrics-grid{grid-template-columns:1fr}.transport-options{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">SI</div>
                <div>
                    <div class="header-title">SENATI Intranet</div>
                    <div class="header-subtitle">Sistema de Encuestas de Transporte Estudiantil</div>
                </div>
            </div>
            <div class="participants-info">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01.99L14 10l-1-1h-1v6h1l1.5-1.5L16 18h4zM12.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm1.5 2C5.01 8 3 9.79 3 12v8h8v-8c0-2.21-2.01-4-4.5-4z"/>
                </svg>
                <span id="participantsCount">6 Participantes</span>
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <div class="nav-tabs-content">
            <a href="#" class="nav-tab active">Dashboard</a>
            <a href="#" class="nav-tab">Nueva Encuesta</a>
            <a href="#" class="nav-tab">Resultados</a>
            <a href="#" class="nav-tab">Chatbot</a>
        </div>
    </nav>

    <main class="container">
        <div class="page-header">
            <h1 class="page-title">Dashboard Principal</h1>
            <p class="page-subtitle">Análisis de datos de transporte estudiantil - Última actualización: hoy</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Total Participantes</span>
                    <div class="metric-icon blue"></div>
                </div>
                <div class="metric-value" id="totalParticipants">6</div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Respuestas Web</span>
                    <div class="metric-icon green"></div>
                </div>
                <div class="metric-value" id="webResponses">4</div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Respuestas Chatbot</span>
                    <div class="metric-icon purple"></div>
                </div>
                <div class="metric-value" id="chatbotResponses">2</div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-label">Tiempo Promedio</span>
                    <div class="metric-icon orange"></div>
                </div>
                <div class="metric-value" id="avgTime">38 min</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="chart-card">
                <h2 class="card-title">Métodos de Transporte</h2>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h2 class="card-title">Tiempo de Viaje por Ubicación</h2>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            <div class="form-card">
                <h2 class="card-title">Registro de Nueva Encuesta</h2>
                <form id="transportSurvey">
                    <div class="form-group">
                        <label class="form-label" for="studentName">Nombre Completo</label>
                        <input type="text" id="studentName" name="studentName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="studentLocation">Ubicación de Residencia</label>
                        <select id="studentLocation" name="studentLocation" class="form-select" required>
                            <option value="">Seleccionar ubicación...</option>
                            <option value="Huancayo">Huancayo</option>
                            <option value="Jauja">Jauja</option>
                            <option value="Chupaca">Chupaca</option>
                            <option value="Sicaya">Sicaya</option>
                            <option value="Orcotuna">Orcotuna</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Medio de Transporte Principal</label>
                        <div class="transport-options">
                            <div class="transport-option">
                                <input type="radio" id="bus" name="transport" value="bus">
                                <label for="bus">Bus</label>
                            </div>
                            <div class="transport-option">
                                <input type="radio" id="auto" name="transport" value="auto">
                                <label for="auto">Auto</label>
                            </div>
                            <div class="transport-option">
                                <input type="radio" id="bicicleta" name="transport" value="bicicleta">
                                <label for="bicicleta">Bicicleta</label>
                            </div>
                            <div class="transport-option">
                                <input type="radio" id="caminata" name="transport" value="caminata">
                                <label for="caminata">Caminata</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tiempo de Viaje al Estudio (minutos)</label>
                        <input type="number" id="travelMinutes" name="travelMinutes" class="form-input" min="1" max="300" placeholder="Ej: 45" required>
                    </div>
                    <button type="submit" class="btn-submit">Registrar Encuesta</button>
                    <div class="success-message" id="successMessage">
                        Encuesta registrada correctamente en el sistema
                    </div>
                </form>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header">
                <h2 class="table-title">Registro de Respuestas Recientes</h2>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Ubicación</th>
                            <th>Transporte</th>
                            <th>Tiempo Viaje</th>
                            <th>Fuente</th>
                            <th>Fecha Registro</th>
                        </tr>
                    </thead>
                    <tbody id="responsesTable">
                        <tr>
                            <td>Ana García Mendoza</td>
                            <td>Huancayo</td>
                            <td><span class="status-badge badge-bus">Bus</span></td>
                            <td>45 min</td>
                            <td><span class="status-badge source-web">Web</span></td>
                            <td>23/09/2025 14:30</td>
                        </tr>
                        <tr>
                            <td>Carlos López Vargas</td>
                            <td>Jauja</td>
                            <td><span class="status-badge badge-auto">Auto</span></td>
                            <td>30 min</td>
                            <td><span class="status-badge source-chatbot">Chatbot</span></td>
                            <td>23/09/2025 13:45</td>
                        </tr>
                        <tr>
                            <td>María Quispe Flores</td>
                            <td>Chupaca</td>
                            <td><span class="status-badge badge-bus">Bus</span></td>
                            <td>60 min</td>
                            <td><span class="status-badge source-web">Web</span></td>
                            <td>23/09/2025 12:20</td>
                        </tr>
                        <tr>
                            <td>José Mendoza Rojas</td>
                            <td>Sicaya</td>
                            <td><span class="status-badge badge-bicicleta">Bicicleta</span></td>
                            <td>25 min</td>
                            <td><span class="status-badge source-web">Web</span></td>
                            <td>23/09/2025 11:10</td>
                        </tr>
                        <tr>
                            <td>Rosa Flores Huamán</td>
                            <td>Orcotuna</td>
                            <td><span class="status-badge badge-caminata">Caminata</span></td>
                            <td>20 min</td>
                            <td><span class="status-badge source-chatbot">Chatbot</span></td>
                            <td>23/09/2025 10:55</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        let surveyData = { bus: 2, auto: 1, bicicleta: 1, caminata: 2 };
        let timeData = { 'Huancayo': 45, 'Jauja': 30, 'Chupaca': 60, 'Sicaya': 25, 'Orcotuna': 20 };
        let totalResponses = 6, webResponses = 4, chatbotResponses = 2;
        let pieChart = null, barChart = null;

        function createPieChart() {
            const ctx = document.getElementById('pieChart');
            if (!ctx) return;
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Bus', 'Auto', 'Bicicleta', 'Caminata'],
                    datasets: [{ data: [surveyData.bus, surveyData.auto, surveyData.bicicleta, surveyData.caminata], backgroundColor: ['#3498db', '#e67e22', '#27ae60', '#e74c3c'], borderWidth: 2, borderColor: '#fff' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 }, usePointStyle: true } } } }
            });
        }

        function createBarChart() {
            const ctx = document.getElementById('barChart');
            if (!ctx) return;
            if (barChart) barChart.destroy();
            barChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(timeData), datasets: [{ label: 'Tiempo (min)', data: Object.values(timeData), backgroundColor: '#27ae60', borderWidth: 0, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { font: { size: 11 } } }, x: { ticks: { font: { size: 11 } } } } }
            });
        }

        function updateCharts() {
            if (pieChart) { pieChart.data.datasets[0].data = [surveyData.bus, surveyData.auto, surveyData.bicicleta, surveyData.caminata]; pieChart.update(); }
            if (barChart) { barChart.data.labels = Object.keys(timeData); barChart.data.datasets[0].data = Object.values(timeData); barChart.update(); }
        }

        function updateMetrics() {
            document.getElementById('totalParticipants').textContent = totalResponses;
            document.getElementById('webResponses').textContent = webResponses;
            document.getElementById('chatbotResponses').textContent = chatbotResponses;
            document.getElementById('participantsCount').textContent = `${totalResponses} Participantes`;
            const avgMinutes = Math.round(Object.values(timeData).reduce((a, b) => a + b, 0) / Object.values(timeData).length);
            document.getElementById('avgTime').textContent = `${avgMinutes} min`;
        }

        function addTableRow(data) {
            const tbody = document.getElementById('responsesTable');
            const row = document.createElement('tr');
            const now = new Date();
            const timestamp = now.toLocaleString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            row.innerHTML = `
                <td>${data.name}</td>
                <td>${data.location}</td>
                <td><span class="status-badge badge-${data.transport}">${data.transport.charAt(0).toUpperCase() + data.transport.slice(1)}</span></td>
                <td>${data.time}</td>
                <td><span class="status-badge source-${data.source}">${data.source === 'web' ? 'Web' : 'Chatbot'}</span></td>
                <td>${timestamp}</td>
            `;
            tbody.insertBefore(row, tbody.firstChild);
        }

        function saveDataToLocalStorage() {
            const data = { surveyData, timeData, totalResponses, webResponses, chatbotResponses };
            localStorage.setItem('transportSurveyData', JSON.stringify(data));
        }

        function loadDataFromLocalStorage() {
            const saved = localStorage.getItem('transportSurveyData');
            if (saved) {
                const data = JSON.parse(saved);
                surveyData = data.surveyData;
                timeData = data.timeData;
                totalResponses = data.totalResponses;
                webResponses = data.webResponses;
                chatbotResponses = data.chatbotResponses;
                return true;
            }
            return false;
        }

        function submitSurvey() {
            const formData = new FormData(document.getElementById('transportSurvey'));
            const transport = formData.get('transport');
            const name = formData.get('studentName');
            const location = formData.get('studentLocation');
            const minutes = parseInt(formData.get('travelMinutes')) || 0;

            if (!transport) { alert('Debe seleccionar un medio de transporte'); return; }
            if (!name.trim()) { alert('Debe ingresar un nombre'); return; }
            if (!location) { alert('Debe seleccionar una ubicación'); return; }
            if (minutes <= 0) { alert('Debe ingresar un tiempo válido en minutos'); return; }

            surveyData[transport]++;
            timeData[location] = minutes;
            totalResponses++;
            webResponses++;
            addTableRow({ name, location, transport, time: `${minutes} min`, source: 'web' });
            updateMetrics();
            updateCharts();
            saveDataToLocalStorage();

            const alert = document.getElementById('successMessage');
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
            document.getElementById('transportSurvey').reset();
            document.querySelectorAll('.transport-option').forEach(opt => opt.classList.remove('selected'));
        }

        window.saveChatbotResponse = function (data) {
            console.log('Datos recibidos del chatbot:', data);
            const transportMap = { bus: 'bus', auto: 'auto', carro: 'auto', automóvil: 'auto', bicicleta: 'bicicleta', bici: 'bicicleta', caminata: 'caminata', caminar: 'caminata', 'a pie': 'caminata' };
            const transport = transportMap[data.transporte?.toLowerCase()] || data.transporte?.toLowerCase();
            const travelTime = parseInt(data.tiempo_llegada) || 0;

            if (transport && surveyData.hasOwnProperty(transport)) {
                surveyData[transport]++;
                if (data.lugar && travelTime > 0) timeData[data.lugar] = travelTime;
                totalResponses++;
                chatbotResponses++;
                addTableRow({ name: data.nombre1 || 'Usuario Chatbot', location: data.lugar || 'No especificado', transport, time: `${travelTime} min`, source: 'chatbot' });
                updateMetrics();
                updateCharts();
                saveDataToLocalStorage();
                console.log('✅ Datos guardados exitosamente');
            } else {
                console.error('❌ Error: Datos del chatbot no válidos:', data);
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            const hasData = loadDataFromLocalStorage();
            setTimeout(() => {
                createPieChart();
                createBarChart();
                updateMetrics();
                if (!hasData) {
                    setTimeout(() => window.saveChatbotResponse({ nombre1: "Luis Rutti", lugar: "Orcotuna", edad: "20", transporte: "bus", tiempo_llegada: "30" }), 1000);
                }
            }, 100);
        });

        document.getElementById('transportSurvey').addEventListener('submit', function (e) { e.preventDefault(); submitSurvey(); });
        document.querySelectorAll('.transport-option').forEach(option => {
            option.addEventListener('click', function () {
                this.querySelector('input[type="radio"]').checked = true;
                document.querySelectorAll('.transport-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        (function (d, t) {
            var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
            v.onload = function () {
                window.voiceflow.chat.load({
                    verify: { projectID: '68cdaac4b16e3e003d3f0e43' },
                    url: 'https://general-runtime.voiceflow.com',
                    versionID: 'production',
                    voice: { url: 'https://runtime-api.voiceflow.com' }
                });
            };
            v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
            v.type = "text/javascript";
            s.parentNode.insertBefore(v, s);
        })(document, 'script');
    </script>
</body>
</html>